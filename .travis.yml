language: bash

sudo: required

services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.11.2
    - DOCKER_VERSION=17.06.2
    - LATEST_TAG=10
  matrix:
    - MAJOR_VER=10 MINOR_VER=10.2

install:
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce="${DOCKER_VERSION}~ce-0~ubuntu"
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

script:
  - cd ./"${MAJOR_VER}"
  - make && make test

after_success: |
  if [[ "${TRAVIS_PULL_REQUEST}" == "false" && ("${TRAVIS_BRANCH}" == "master"  || -n "${TRAVIS_TAG}") ]]; then
    docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"

    make release
    make release TAG="${MINOR_VER}"

    if [[ -n "${TRAVIS_TAG}" ]]; then
      make release TAG="${TAG}-${TRAVIS_TAG}"
    elif [[ "${TAG}" == "${LATEST_TAG}" ]]; then
      make release TAG="latest"
      make release TAG="${MAJOR_VER}"
    fi
  fi

notifications:
  on_failure: never
  slack:
    secure: ghPU8CT/vM0kTDjXtMOvTyfJE6rgoh33lbUzQDWFJNntu5XMa6vvf3guGRQFMK/qg+Yvn5Eys40ZXNoj3UtZpcjgJQKigmoW8nleBh/mmlbYVQLCZxrHCKqZ0K96PyhwJpHF7K4tXfVWtTikbd9bD5pMrKtqiGmIJtG8bCr6i8+anoHPsXCUuKpkzn/Yi8B+yGWgVsdVlw3Ay9uRmRmkZnn9lJfysaLGJ6fJlh+xsOZ5X9UhjuGVzoJOt/bI5u6NKN4w0646pq236TsxCFuD9o+JQw6o2za55bamHGvPyr7uv16SKkrhB68zJHrndh0LxV6LP3pjkUDCNWX4woJfge2NtseRMnM+4Mntu4uwi4DIoErlFVmdwPxRaH1f2O1M75Gj8HoD4Eb6uWD2exn91M72x1GwKZ/sI8UywEPF98A/9tD8YMm9BR6yYXt7hc+pM4bshZBX1SEdw/vCE1FCdxoYH5WLpBtqK/WKefgH8nX169g9QIK1EY+GzzJuGbZBElDjlZjm8RJMreYHOQmsvbjQxoOiuJouI/fxwpPTPA9lon2n+YOkwAPLeUm7JJbbDsKZvRZO6E1mvB6srgwKBs58pbQJrYL9K205awZpnEp1rfhUmmIV8Kyy0PJAyDk0SrzMWThTcvMmFWNt08i8i72voHTv+7YdQl2SslkosRw=
