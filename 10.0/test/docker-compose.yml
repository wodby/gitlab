version: '2'

services:

  nginx:
    image: wodby/gitlab-nginx
    depends_on:
      - workhorse
    ports:
      - "80:80"
    environment:
      - DEBUG=true
    volumes:
      - data:/mnt/data

  redis:
    image: wodby/redis

  postgres:
    image: wodby/postgres:9.6
    environment:
    - POSTGRES_USER=gitlab
    - POSTGRES_PASSWORD=gitlab
    - POSTGRES_DB=gitlab
    - POSTGRES_DB_EXTENSIONS=pg_trgm

#  runner:
#    image: gitlab/gitlab-runner:alpine-v9.5.0
#    depends_on:
#      - gitlab
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
##      - ./config.toml:/etc/gitlab-runner/config.toml
#      - data:/mnt/data

  gitlab:
    image: $IMAGE
    depends_on:
      - redis
      - postgres
      - gitaly
    environment:
      - DEBUG=true
      - GITLAB_HOST=gitlab.loc
#      - GITLAB_LOG_LEVEL=debug
      - GITLAB_ROOT_PASSWORD=password
      - GITLAB_ROOT_EMAIL=admin@example.com
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=gitlab
      - DB_PASS=gitlab
      - DB_NAME=gitlab
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alphanumeric-string
      - GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alphanumeric-string
      - GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alphanumeric-string
      # openssl rand -hex 16
      - GITLAB_SECRETS_SHELL=892ce4f50cd917845a02ba3744a51a4d
      # openssl rand -base64 32
      - GITLAB_SECRETS_WORKHORSE=Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
#    command: bundle exec unicorn_rails -c config/unicorn.rb -E production -d
    expose:
      - "8080"
    volumes:
      - data:/mnt/data

  gitaly:
    image: $IMAGE
    environment:
      - DEBUG=true
    working_dir: /home/git/gitaly
    command: /etc/init.d/gitaly
    expose:
      - "9999"
    volumes:
      - data:/mnt/data

  workhorse:
    image: $IMAGE
    depends_on:
      - gitlab
      - redis
    environment:
      - DEBUG=true
      # openssl rand -base64 32
      - GITLAB_SECRETS_WORKHORSE=Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
      # openssl rand -hex 16
      - GITLAB_SECRETS_SHELL=892ce4f50cd917845a02ba3744a51a4d
    working_dir: /home/git/gitlab-workhorse
    command: /etc/init.d/workhorse
    expose:
      - "8181"
    volumes:
      - data:/mnt/data

  sidekiq:
    image: $IMAGE
    depends_on:
      - gitlab
    environment:
      - DEBUG=true
#      - GITLAB_LOG_LEVEL=debug
      - GITLAB_ROOT_PASSWORD=password
      - GITLAB_ROOT_EMAIL=admin@example.com
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=gitlab
      - DB_PASS=gitlab
      - DB_NAME=gitlab
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alphanumeric-string
      - GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alphanumeric-string
      - GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alphanumeric-string
      # openssl rand -hex 16
      - GITLAB_SECRETS_SHELL=892ce4f50cd917845a02ba3744a51a4d
      # openssl rand -base64 32
      - GITLAB_SECRETS_WORKHORSE=Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
    command: /etc/init.d/sidekiq
    volumes:
      - data:/mnt/data

  sshd:
    image: $IMAGE
    depends_on:
      - gitlab
    environment:
      - RUBYOPT=--disable-gems
      - DEBUG=true
      - GITLAB_SHELL_LOG_LEVEL=debug
      - GITLAB_SHELL_REDIS_HOST=redis
      - GITLAB_SHELL_REDIS_PORT=6379
      # openssl rand -hex 16
      - GITLAB_SECRETS_SHELL=892ce4f50cd917845a02ba3744a51a4d
    working_dir: /home/git/gitlab-shell
    command: sudo /usr/sbin/sshd -De
    ports:
      - "22:22"
    volumes:
      - data:/mnt/data

volumes:
  data: