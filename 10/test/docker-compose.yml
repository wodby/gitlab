version: '2'

services:

  nginx:
    image: wodby/gitlab-nginx
    depends_on:
      - workhorse
    ports:
      - "80:80"
    environment:
#      DEBUG: 1
      NGINX_ERROR_LOG_LEVEL: debug
      NGINX_GITLAB_PAGES_DOMAIN: pages.gitlab.loc
    volumes:
      - data:/mnt/data

  redis:
    image: wodby/redis

  postgres:
    image: wodby/postgres:9.6
    environment:
#      DEBUG: 1
      POSTGRES_USER: gitlab
      POSTGRES_PASSWORD: gitlab
      POSTGRES_DB: gitlab
      POSTGRES_DB_EXTENSIONS: pg_trgm

  gitlab:
    image: $IMAGE
    depends_on:
      - redis
      - postgres
      - gitaly
    environment:
#      DEBUG: 1
#      GITLAB_LOG_LEVEL: debug
      GITLAB_REGISTRY_ENABLED: "true"
      GITLAB_REGISTRY_HOST: registry
      GITLAB_REGISTRY_PORT: 5000
      GITLAB_REGISTRY_API_URL: http://registry:5000/
      GITLAB_REGISTRY_KEY: /mnt/data/certs/registry-auth.key
      GITLAB_PAGES_ENABLED: "true"
      GITLAB_PAGES_HOST: pages.gitlab.loc
      GITLAB_PAGES_PORT: 80
      GITLAB_PAGES_HTTPS: "false"
#      GITLAB_INCOMING_EMAIL: "true"
      GITLAB_INCOMING_EMAIL_ADDRESS: $IMAP_ADDRESS
      GITLAB_INCOMING_EMAIL_USER: $IMAP_USER
      GITLAB_INCOMING_EMAIL_PASSWORD: $IMAP_PASSWORD
      GITLAB_INCOMING_EMAIL_HOST: $IMAP_HOST
      GITLAB_INCOMING_EMAIL_PORT: $IMAP_PORT
      GITLAB_HOST: gitlab.loc
      GITLAB_ROOT_PASSWORD: password
      GITLAB_ROOT_EMAIL: admin@example.com
      GITLAB_EMAIL_FROM: gitlab@example.com
      DB_ADAPTER: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gitlab
      DB_PASS: gitlab
      DB_NAME: gitlab
      REDIS_HOST: redis
      REDIS_PORT: 6379
      GITLAB_SMTP_ADDRESS: opensmtpd
      GITLAB_SMTP_PORT: 25
      GITLAB_SECRETS_DB_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_SECRET_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_OTP_KEY_BASE: long-and-random-alphanumeric-string
      # openssl rand -hex 16
      GITLAB_SECRETS_SHELL: 892ce4f50cd917845a02ba3744a51a4d
      # openssl rand -base64 32
      GITLAB_SECRETS_WORKHORSE: Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
    expose:
      - "8080"
    volumes:
      - data:/mnt/data

  sidekiq:
    image: $IMAGE
    environment:
#      DEBUG: 1
#      GITLAB_LOG_LEVEL: debug
      GITLAB_REGISTRY_ENABLED: "true"
      GITLAB_REGISTRY_HOST: registry
      GITLAB_REGISTRY_PORT: 5000
      GITLAB_REGISTRY_API_URL: http://registry:5000/
      GITLAB_REGISTRY_KEY: /mnt/data/certs/registry-auth.key
      GITLAB_PAGES_ENABLED: "true"
      GITLAB_PAGES_HOST: pages.gitlab.loc
      GITLAB_PAGES_PORT: 80
      GITLAB_PAGES_HTTPS: "false"
#      GITLAB_INCOMING_EMAIL: "true"
      GITLAB_INCOMING_EMAIL_ADDRESS: $IMAP_ADDRESS
      GITLAB_INCOMING_EMAIL_USER: $IMAP_USER
      GITLAB_INCOMING_EMAIL_PASSWORD: $IMAP_PASSWORD
      GITLAB_INCOMING_EMAIL_HOST: $IMAP_HOST
      GITLAB_INCOMING_EMAIL_PORT: $IMAP_PORT
      GITLAB_ROOT_PASSWORD: password
      GITLAB_ROOT_EMAIL: admin@example.com
      GITLAB_EMAIL_FROM: gitlab@example.com
      DB_ADAPTER: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gitlab
      DB_PASS: gitlab
      DB_NAME: gitlab
      REDIS_HOST: redis
      REDIS_PORT: 6379
      GITLAB_SMTP_ADDRESS: opensmtpd
      GITLAB_SMTP_PORT: 25
      GITLAB_SECRETS_DB_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_SECRET_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_OTP_KEY_BASE: long-and-random-alphanumeric-string
      # openssl rand -hex 16
      GITLAB_SECRETS_SHELL: 892ce4f50cd917845a02ba3744a51a4d
      # openssl rand -base64 32
      GITLAB_SECRETS_WORKHORSE: Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
    command: /etc/init.d/sidekiq
    volumes:
      - data:/mnt/data

  mailroom:
    image: $IMAGE
    environment:
#      DEBUG: 1
#      GITLAB_LOG_LEVEL: debug
      GITLAB_REGISTRY_ENABLED: "true"
      GITLAB_REGISTRY_HOST: registry
      GITLAB_REGISTRY_PORT: 5000
      GITLAB_REGISTRY_API_URL: http://registry:5000/
      GITLAB_REGISTRY_KEY: /mnt/data/certs/registry-auth.key
      GITLAB_PAGES_ENABLED: "true"
      GITLAB_PAGES_HOST: pages.gitlab.loc
      GITLAB_PAGES_PORT: 80
      GITLAB_PAGES_HTTPS: "false"
#      GITLAB_INCOMING_EMAIL: "true"
      GITLAB_INCOMING_EMAIL_ADDRESS: $IMAP_ADDRESS
      GITLAB_INCOMING_EMAIL_USER: $IMAP_USER
      GITLAB_INCOMING_EMAIL_PASSWORD: $IMAP_PASSWORD
      GITLAB_INCOMING_EMAIL_HOST: $IMAP_HOST
      GITLAB_INCOMING_EMAIL_PORT: $IMAP_PORT
      GITLAB_ROOT_PASSWORD: password
      GITLAB_ROOT_EMAIL: admin@example.com
      DB_ADAPTER: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gitlab
      DB_PASS: gitlab
      DB_NAME: gitlab
      REDIS_HOST: redis
      REDIS_PORT: 6379
      GITLAB_SMTP_ADDRESS: opensmtpd
      GITLAB_SMTP_PORT: 25
      GITLAB_SECRETS_DB_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_SECRET_KEY_BASE: long-and-random-alphanumeric-string
      GITLAB_SECRETS_OTP_KEY_BASE: long-and-random-alphanumeric-string
      # openssl rand -hex 16
      GITLAB_SECRETS_SHELL: 892ce4f50cd917845a02ba3744a51a4d
      # openssl rand -base64 32
      GITLAB_SECRETS_WORKHORSE: Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
    command: /etc/init.d/mailroom
    volumes:
      - data:/mnt/data

  gitaly:
    image: $IMAGE
#    environment:
#      DEBUG: 1
    command: /etc/init.d/gitaly
    expose:
      - "9999"
    volumes:
      - data:/mnt/data

  workhorse:
    image: $IMAGE
    depends_on:
      - gitlab
      - redis
    environment:
#      DEBUG: 1
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # openssl rand -base64 32
      GITLAB_SECRETS_WORKHORSE: Wh4/VODsUdhUQMXSaqYEh3xCbqZ0KRE9j8Z/JtPpjfQ=
      # openssl rand -hex 16
      GITLAB_SECRETS_SHELL: 892ce4f50cd917845a02ba3744a51a4d
    command: /etc/init.d/workhorse
    expose:
      - "8181"
    volumes:
      - data:/mnt/data

  sshd:
    image: $IMAGE
    environment:
#      DEBUG: 1
      GITLAB_SHELL_LOG_LEVEL: debug
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # openssl rand -hex 16
      GITLAB_SECRETS_SHELL: 892ce4f50cd917845a02ba3744a51a4d
    working_dir: /home/git/gitlab-shell
    command: sudo /usr/sbin/sshd -De
    ports:
      - "2222:22"
    volumes:
      - data:/mnt/data

  pages:
    image: $IMAGE
    environment:
#      DEBUG: 1
      GITLAB_PAGES_DOMAIN: pages.gitlab.loc
    command: /etc/init.d/pages
    volumes:
      - data:/mnt/data

  opensmtpd:
    image: wodby/opensmtpd
    environment:
#      DEBUG: 1
      RELAY_HOST: $RELAY_HOST
      RELAY_USER: $RELAY_USER
      RELAY_PASSWORD: $RELAY_PASSWORD

  registry:
    image: registry:2
    depends_on:
      - gitlab
#    environment:
#      REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE: /mnt/data/certs/registry-auth.crt
#      REGISTRY_AUTH_TOKEN_REALM: http://gitlab/jwt/auth
#      REGISTRY_AUTH_TOKEN_SERVICE: container_registry
#      REGISTRY_AUTH_TOKEN_ISSUER: gitlab-issuer
    volumes:
      - data:/mnt/data

#  runner:
#    image: wodby/gitlab-runner
#    depends_on:
#      - gitlab
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
##      - ./config.toml:/etc/gitlab-runner/config.toml
#      - data:/mnt/data

volumes:
  data: