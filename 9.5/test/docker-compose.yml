version: '2'

services:
  redis:
    image: wodby/redis

  postgres:
    image: wodby/postgres:9.6
    environment:
    - POSTGRES_USER=gitlab
    - POSTGRES_PASSWORD=gitlab
    - POSTGRES_DB=gitlab
    - POSTGRES_DB_EXTENSIONS=pg_trgm

  gitaly:
    image: wodby/gitaly
    environment:
      - DEBUG=true
    volumes:
      - data:/mnt/data

  gitlab:
    image: $IMAGE
    depends_on:
      - redis
      - postgres
      - gitaly
    environment:
      - DEBUG=true
      - GITLAB_LOG_LEVEL=debug
      - GITLAB_SHELL_LOG_LEVEL=debug
      - GITLAB_ROOT_PASSWORD=password
      - GITLAB_ROOT_EMAIL=admin@example.com
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=gitlab
      - DB_PASS=gitlab
      - DB_NAME=gitlab
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - data:/mnt/data

  workhorse:
    image: wodby/gitlab-workhorse
    depends_on:
      - gitlab
      - redis
    environment:
      - DEBUG=true
    volumes:
      - data:/mnt/data

  sidekiq:
    image: $IMAGE
    depends_on:
      - gitlab
    environment:
      - DEBUG=true
      - GITLAB_LOG_LEVEL=debug
      - GITLAB_SHELL_LOG_LEVEL=debug
      - GITLAB_ROOT_PASSWORD=password
      - GITLAB_ROOT_EMAIL=admin@example.com
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=gitlab
      - DB_PASS=gitlab
      - DB_NAME=gitlab
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    command: /etc/init.d/sidekiqd
    volumes:
      - data:/mnt/data

  sshd:
    image: $IMAGE
    depends_on:
      - gitlab
    environment:
      - RUBYOPT=--disable-gems
      - DEBUG=true
      - GITLAB_LOG_LEVEL=debug
      - GITLAB_SHELL_LOG_LEVEL=debug
      - GITLAB_INCOMING_EMAIL=true
      - GITLAB_INCOMING_EMAIL_USER=$IMAP_EMAIL
      - GITLAB_INCOMING_EMAIL_PASSWORD=$IMAP_PASS
      - GITLAB_ROOT_PASSWORD=password
      - GITLAB_ROOT_EMAIL=admin@example.com
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=gitlab
      - DB_PASS=gitlab
      - DB_NAME=gitlab
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    command: sudo /usr/sbin/sshd -De
    ports:
      - "22:22"
    volumes:
      - data:/mnt/data

  nginx:
    image: wodby/gitlab-nginx
    depends_on:
      - workhorse
    ports:
      - "80:80"
    environment:
      - DEBUG=true
    volumes:
      - data:/mnt/data

volumes:
  data: